<layout>main</layout>

<imports>
  import CarForm from '../components/CarForm.puremix'
  import ResultChart from '../components/ResultChart.puremix'
  import StatisticsPanel from '../components/StatisticsPanel.puremix'
</imports>

<loader>
  async function loadPage(request, actionResult) {
    actionResult = actionResult || null;
    // Handle action results (from form submissions)
    let predictionResult = null;
    let notification = null;

    if (actionResult) {
      if (actionResult.success && actionResult.prediction) {
        predictionResult = actionResult.prediction;
        notification = {
          success: true,
          message: actionResult.message
        };
      } else if (!actionResult.success) {
        notification = {
          success: false,
          message: actionResult.message
        };
      }
    }

    return {
      data: {
        predictionResult,
        notification,
        pageTitle: 'Car Price Predictor'
      }
    };
  }
</loader>

<div class="max-w-6xl mx-auto">
  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">Car Price Predictor</h1>
    <p class="mt-2 text-gray-600">
      Get accurate vehicle price predictions using our machine learning model trained on thousands of car listings.
      Our model considers brand, model, year, mileage, condition, and various features to provide reliable estimates.
    </p>
  </div>

  <!-- Main Content Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Prediction Form -->
    <div class="lg:col-span-2">
      <CarForm notification={loadPage.data.notification} />

      <!-- Results Section -->
      {loadPage.data.predictionResult ?
        <div class="mt-8">
          <ResultChart prediction={loadPage.data.predictionResult} />
        </div>
      : <div></div>}
    </div>

    <!-- Statistics Sidebar -->
    <div>
      <StatisticsPanel predictionType="car" />
    </div>
  </div>

  <!-- Depreciation Chart -->
  <div class="mt-8 bg-white rounded-lg shadow p-6">
    <h2 class="text-xl font-bold text-gray-900 mb-4">Depreciation by Age</h2>
    <div class="chart-container" style="height: 300px; position: relative;">
      <canvas id="depreciation-chart"></canvas>
    </div>
    <p class="text-sm text-gray-600 mt-2">
      Cars typically lose 15-20% of their value in the first year and about 10% each subsequent year.
    </p>
  </div>

  <!-- Additional Information -->
  <div class="mt-8 bg-white rounded-lg shadow p-6">
    <h2 class="text-xl font-bold text-gray-900 mb-4">How Our Model Works</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <h3 class="font-semibold text-gray-900 mb-2">Factors Considered</h3>
        <ul class="space-y-1 text-sm text-gray-600">
          <li>• Make and model</li>
          <li>• Year of manufacture</li>
          <li>• Mileage (kilometers)</li>
          <li>• Fuel type (gas, diesel, hybrid, electric)</li>
          <li>• Vehicle condition</li>
          <li>• Engine size and drivetrain</li>
          <li>• Brand tier and market position</li>
          <li>• Additional features and options</li>
        </ul>
      </div>
      <div>
        <h3 class="font-semibold text-gray-900 mb-2">Model Accuracy</h3>
        <div class="space-y-2">
          <div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">R² Score</span>
              <span class="font-medium">0.92</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-blue-600 h-2 rounded-full" style="width: 92%"></div>
            </div>
          </div>
          <div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Average Error</span>
              <span class="font-medium">5.8%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-green-600 h-2 rounded-full" style="width: 94.2%"></div>
            </div>
          </div>
        </div>
        <p class="text-sm text-gray-600 mt-2">
          Our model achieves exceptional accuracy with an average error rate of under 6%.
        </p>
      </div>
    </div>
  </div>
</div>

<script client>
  // Global chart registry to prevent duplicate charts
  window.puremixCharts = window.puremixCharts || {};

  function initDepreciationChart() {
    const canvas = document.getElementById('depreciation-chart');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');

    // Destroy existing chart if it exists
    if (window.puremixCharts['depreciation']) {
      window.puremixCharts['depreciation'].destroy();
      delete window.puremixCharts['depreciation'];
    }

    // Sample depreciation data
    const years = [0, 1, 2, 3, 4, 5, 7, 10];
    const values = [100, 85, 73, 63, 55, 48, 38, 25];

    window.puremixCharts['depreciation'] = new Chart(ctx, {
      type: 'line',
      data: {
        labels: years.map(y => y === 0 ? 'New' : `${y} year${y > 1 ? 's' : ''}`),
        datasets: [{
          label: 'Resale Value (%)',
          data: values,
          borderColor: 'rgb(59, 130, 246)',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `Value: ${context.parsed.y}% of original price`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: {
              callback: function(value) {
                return value + '%';
              }
            }
          }
        }
      }
    });
  }

  // Initialize on DOMContentLoaded or immediately if DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDepreciationChart);
  } else {
    initDepreciationChart();
  }
</script>