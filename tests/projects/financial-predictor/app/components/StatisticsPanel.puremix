<imports>
  import { DataManager } from '../lib/data-manager.js'
</imports>

<loader>
  async function loadStatisticsPanel(request, actionResult) {
    const predictionType = request.props.predictionType || 'real-estate';

    // Load data
    const realEstateData = await DataManager.readData('real-estate.json');
    const carsData = await DataManager.readData('cars.json');
    const predictions = await DataManager.getPredictionHistory(10);

    // Calculate statistics based on type
    let statistics = {};

    if (predictionType === 'real-estate') {
      // Call Python for detailed statistics
      const statsResult = await request.python.executeFile(
        './app/services/real-estate-predictor.py',
        'get_market_statistics',
        realEstateData
      );

      if (statsResult.success) {
        statistics = statsResult.data;
      }
    } else {
      // Call Python for car statistics
      const statsResult = await request.python.executeFile(
        './app/services/car-predictor.py',
        'get_car_market_statistics',
        carsData
      );

      if (statsResult.success) {
        statistics = statsResult.data;
      }
    }

    return {
      data: {
        predictionType,
        statistics,
        recentPredictions: predictions.filter(p => p.type === predictionType),
        totalData: predictionType === 'real-estate' ? realEstateData.length : carsData.length
      }
    };
  }
</loader>

<div class="statistics-panel space-y-6">
  <!-- Overview Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <div class="bg-white p-4 rounded-lg shadow">
      <p class="text-sm font-medium text-gray-600">Total {loadStatisticsPanel.data.predictionType === 'real-estate' ? 'Properties' : 'Cars'}</p>
      <p class="text-2xl font-bold text-gray-900">{loadStatisticsPanel.data.totalData}</p>
    </div>
    <div class="bg-white p-4 rounded-lg shadow">
      <p class="text-sm font-medium text-gray-600">Average Price</p>
      <p class="text-2xl font-bold text-primary">
        {loadStatisticsPanel.data.statistics.average_price ?
          '$' + (loadStatisticsPanel.data.statistics.average_price / 1000).toFixed(0) + 'K'
          : 'N/A'
        }
      </p>
    </div>
    <div class="bg-white p-4 rounded-lg shadow">
      <p class="text-sm font-medium text-gray-600">Median Price</p>
      <p class="text-2xl font-bold text-secondary">
        {loadStatisticsPanel.data.statistics.median_price ?
          '$' + (loadStatisticsPanel.data.statistics.median_price / 1000).toFixed(0) + 'K'
          : 'N/A'
        }
      </p>
    </div>
    <div class="bg-white p-4 rounded-lg shadow">
      <p class="text-sm font-medium text-gray-600">Total Predictions</p>
      <p class="text-2xl font-bold text-success">{loadStatisticsPanel.data.recentPredictions.length}</p>
    </div>
  </div>

  <!-- Price Distribution -->
  <div class="bg-white p-6 rounded-lg shadow">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">Price Distribution</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <div class="space-y-2">
          <div class="flex justify-between">
            <span class="text-sm text-gray-600">Minimum Price</span>
            <span class="text-sm font-medium">
              {loadStatisticsPanel.data.statistics.price_range ?
                '$' + (loadStatisticsPanel.data.statistics.price_range.min / 1000).toFixed(0) + 'K'
                : 'N/A'
              }
            </span>
          </div>
          <div class="flex justify-between">
            <span class="text-sm text-gray-600">25th Percentile</span>
            <span class="text-sm font-medium">
              {loadStatisticsPanel.data.statistics.average_price ?
                '$' + (loadStatisticsPanel.data.statistics.average_price * 0.75 / 1000).toFixed(0) + 'K'
                : 'N/A'
              }
            </span>
          </div>
          <div class="flex justify-between">
            <span class="text-sm text-gray-600">Median</span>
            <span class="text-sm font-medium">
              {loadStatisticsPanel.data.statistics.median_price ?
                '$' + (loadStatisticsPanel.data.statistics.median_price / 1000).toFixed(0) + 'K'
                : 'N/A'
              }
            </span>
          </div>
          <div class="flex justify-between">
            <span class="text-sm text-gray-600">75th Percentile</span>
            <span class="text-sm font-medium">
              {loadStatisticsPanel.data.statistics.average_price ?
                '$' + (loadStatisticsPanel.data.statistics.average_price * 1.25 / 1000).toFixed(0) + 'K'
                : 'N/A'
              }
            </span>
          </div>
          <div class="flex justify-between">
            <span class="text-sm text-gray-600">Maximum Price</span>
            <span class="text-sm font-medium">
              {loadStatisticsPanel.data.statistics.price_range ?
                '$' + (loadStatisticsPanel.data.statistics.price_range.max / 1000).toFixed(0) + 'K'
                : 'N/A'
              }
            </span>
          </div>
        </div>
      </div>
      <div>
        <canvas id="price-distribution-chart" height="150"></canvas>
      </div>
    </div>
  </div>

  <!-- Top Categories -->
  {loadStatisticsPanel.data.predictionType === 'real-estate' && loadStatisticsPanel.data.statistics.top_locations ?
    <div class="bg-white p-6 rounded-lg shadow">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Top Locations by Average Price</h3>
      <div class="space-y-2">
        {Object.entries(loadStatisticsPanel.data.statistics.top_locations).slice(0, 5).map(([location, price]) =>
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
            <span class="font-medium text-gray-900">{location}</span>
            <span class="text-primary font-semibold">${(price / 1000).toFixed(0)}K</span>
          </div>
        )}
      </div>
    </div>
  : ''
  }

  {loadStatisticsPanel.data.predictionType === 'car' && loadStatisticsPanel.data.statistics.top_brands ?
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white p-6 rounded-lg shadow">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Brands by Average Price</h3>
        <div class="space-y-2">
          {Object.entries(loadStatisticsPanel.data.statistics.top_brands).slice(0, 5).map(([brand, price]) =>
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
              <span class="font-medium text-gray-900">{brand}</span>
              <span class="text-primary font-semibold">${(price / 1000).toFixed(0)}K</span>
            </div>
          )}
        </div>
      </div>
      <div class="bg-white p-6 rounded-lg shadow">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Price by Fuel Type</h3>
        <div class="space-y-2">
          {Object.entries(loadStatisticsPanel.data.statistics.price_by_fuel_type).map(([fuelType, price]) =>
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
              <span class="font-medium text-gray-900 capitalize">{fuelType.replace('_', ' ')}</span>
              <span class="text-primary font-semibold">${(price / 1000).toFixed(0)}K</span>
            </div>
          )}
        </div>
      </div>
    </div>
  : ''}

  <!-- Recent Predictions -->
  {loadStatisticsPanel.data.recentPredictions.length > 0 ?
    <div class="bg-white p-6 rounded-lg shadow">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Recent Predictions</h3>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
              {loadStatisticsPanel.data.predictionType === 'real-estate' ?
                `<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Location</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Size (sqm)</th>`
              :
                `<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Brand</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Model</th>
              `
              }
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Predicted Price</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            {loadStatisticsPanel.data.recentPredictions.map(prediction =>
              <tr>
                <td class="px-4 py-3 text-sm text-gray-900">
                  {new Date(prediction.timestamp).toLocaleDateString()}
                </td>
                {loadStatisticsPanel.data.predictionType === 'real-estate' ?
                  `<td class="px-4 py-3 text-sm text-gray-900">${prediction.input.location}</td>
                  <td class="px-4 py-3 text-sm text-gray-900">${prediction.input.square_meters}</td>`
                :
                  `<td class="px-4 py-3 text-sm text-gray-900">${prediction.input.brand}</td>
                  <td class="px-4 py-3 text-sm text-gray-900">${prediction.input.model}</td>`
                }
                <td class="px-4 py-3 text-sm font-medium text-primary">
                  ${(prediction.result.predicted_price / 1000).toFixed(0)}K
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  : ''}
</div>

<script client>
  document.addEventListener('DOMContentLoaded', function() {
    const canvas = document.getElementById('price-distribution-chart');
    if (canvas && PureMix.data.loadStatisticsPanel.data.statistics.average_price) {
      const ctx = canvas.getContext('2d');
      const stats = PureMix.data.loadStatisticsPanel.data.statistics;

      // Create price distribution chart
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Min', '25%', 'Median', '75%', 'Max'],
          datasets: [{
            label: 'Price Distribution',
            data: [
              stats.price_range?.min * 0.9 || 0,
              stats.average_price * 0.75,
              stats.median_price,
              stats.average_price * 1.25,
              stats.price_range?.max * 1.1 || 0
            ],
            borderColor: 'rgb(59, 130, 246)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              ticks: {
                callback: function(value) {
                  return '$' + (value / 1000) + 'k';
                }
              }
            }
          }
        }
      });
    }
  });
</script>