<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ü§ñ Machine Learning Test Suite - PureMix Framework</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .feature-card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .feature-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .metric-badge {
      font-size: 0.875rem;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-weight: 600;
    }
    .model-card {
      border-left: 4px solid #007bff;
      transition: all 0.3s ease;
    }
    .model-card:hover {
      border-left-color: #0056b3;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .prediction-result {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 0.5rem;
      padding: 1rem;
      margin: 0.5rem 0;
    }
    .model-stats {
      font-size: 0.875rem;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .json-preview {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 0.375rem;
      padding: 1rem;
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>

<body>
<div class="container py-4">
  <div class="row">
    <div class="col-12">
      <h1 class="display-4 mb-4">ü§ñ Machine Learning Test Suite</h1>
      <p class="lead mb-5">Comprehensive ML model training, persistence, and prediction system using the PureMix framework with NumPy, Pandas, and Scikit-learn integration.</p>
    </div>
  </div>

  <!-- Navigation Tabs -->
  <div class="row mb-4">
    <div class="col-12">
      <ul class="nav nav-tabs" id="mlTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="models-tab" data-bs-toggle="tab" data-bs-target="#models" type="button" role="tab" aria-controls="models" aria-selected="true">
            üóÉÔ∏è Saved Models ({loadMLTest.data.savedModels.count || 0})
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="train-tab" data-bs-toggle="tab" data-bs-target="#train" type="button" role="tab" aria-controls="train" aria-selected="false">
            üöÄ Train New Model
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="predict-tab" data-bs-toggle="tab" data-bs-target="#predict" type="button" role="tab" aria-controls="predict" aria-selected="false">
            üìà Predict
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="library-tab" data-bs-toggle="tab" data-bs-target="#library" type="button" role="tab" aria-controls="library" aria-selected="false">
            üìö ML Libraries
          </button>
        </li>
      </ul>
    </div>
  </div>

  <!-- Models Tab Content -->
  <div class="tab-content active" id="models">
    <div class="row mb-4">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2>üóÉÔ∏è Saved ML Models</h2>
          <button class="btn btn-outline-primary btn-sm" onclick="refreshModels">üîÑ Refresh Models</button>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-12" id="models-container">
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3">Loading saved models...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Train Tab Content -->
  <div class="tab-content" id="train">
    <div class="row mb-4">
      <div class="col-12">
        <h2>üöÄ Train New ML Model</h2>
        <p class="text-muted">Upload training data to create and save a persistent ML model that you can use for future predictions.</p>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h5>üìä Training Data Configuration</h5>
            <form onsubmit="trainModel">
              <div class="mb-3">
                <label class="form-label">Training Data (JSON Array)</label>
                <textarea class="form-control" name="trainingData" rows="8" id="trainingDataTextarea" placeholder="Example training data..."></textarea>
                <small class="form-text">Format: Array of objects with "features" (array) and "target" (number)</small>
              </div>

              <div class="mb-3">
                <label class="form-label">Model Name</label>
                <input type="text" class="form-control" name="modelName" placeholder="e.g., House Price Predictor" required>
              </div>

              <div class="mb-3">
                <label class="form-label">Description</label>
                <input type="text" class="form-control" name="modelDescription" placeholder="e.g., Predicts house prices based on features">
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Algorithm</label>
                    <select class="form-select" name="algorithm">
                      <option value="linear_regression">Linear Regression</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Test Size</label>
                    <input type="number" class="form-control" name="testSize" value="0.3" min="0.1" max="0.9" step="0.1">
                    <small class="form-text">Fraction of data for testing</small>
                  </div>
                </div>
              </div>

              <button type="submit" class="btn btn-primary w-100">üöÄ Train & Save Model</button>
            </form>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h5>üìã Model Training Results</h5>
            <div id="training-results" class="text-muted">
              <div class="text-center py-3">
                <p>Training results will appear here after you train a model.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Predict Tab Content -->
  <div class="tab-content" id="predict">
    <div class="row mb-4">
      <div class="col-12">
        <h2>üìà Make Predictions</h2>
        <p class="text-muted">Use your saved models to make predictions on new data.</p>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card">
          <div class="card-body">
            <h5>üéØ Select Model</h5>
            <select class="form-select mb-3" id="modelSelect">
              <option value="">Choose a model...</option>
            </select>
            <div id="selected-model-info" class="text-muted small"></div>

            <hr>

            <div class="d-grid gap-2">
              <button class="btn btn-info" onclick="testWithSampleData()" disabled id="testSampleBtn">
                üß™ Test with Sample Data
              </button>
              <small class="text-muted">
                Quick test with intelligent sample data based on model characteristics
              </small>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card">
          <div class="card-body">
            <h5>üìä Prediction Data</h5>
            <form onsubmit="makePrediction">
              <div class="mb-3">
                <label class="form-label">Feature Data</label>
                <textarea class="form-control" name="predictionData" rows="4" placeholder="[
  [1.0, 2.0],
  [2.0, 3.0],
  [3.0, 1.0]
]"></textarea>
                <small class="form-text">Format: Array of feature arrays</small>
              </div>
              <button type="submit" class="btn btn-success w-100" disabled id="predictBtn">üìà Predict</button>
            </form>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card">
          <div class="card-body">
            <h5>üìä Prediction Results</h5>
            <div id="prediction-results" class="text-muted">
              <div class="text-center py-3">
                <p>Prediction results will appear here.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sample Data Test Results -->
    <div class="row" id="sample-test-results-row" style="display: none;">
      <div class="col-12">
        <div class="card border-info">
          <div class="card-header bg-info text-white">
            <h6 class="mb-0">üß™ Sample Data Test Results</h6>
          </div>
          <div class="card-body">
            <div id="sample-test-results">
              <!-- Sample test results will be displayed here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Library Tab Content -->
  <div class="tab-content" id="library">
    <div class="row mb-4">
      <div class="col-12">
        <h2>üìö ML Library Availability</h2>
        <p class="text-muted">Check which ML libraries are available in the Python environment.</p>
      </div>
    </div>

    <div class="row" id="library-status">
      <div class="col-md-6 col-lg-3">
        <div class="card feature-card">
          <div class="card-body text-center">
            <h6>‚úÖ NumPy</h6>
            <div class="metric-badge bg-primary text-white">v{loadMLTest.data.libraryTest.numpy.version}</div>
            <div>Test: {loadMLTest.data.libraryTest.numpy.test_result}</div>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="card feature-card">
          <div class="card-body text-center">
            <h6>‚úÖ Pandas</h6>
            <div class="metric-badge bg-success text-white">v{loadMLTest.data.libraryTest.pandas.version}</div>
            <div>DataFrame test passed</div>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="card feature-card">
          <div class="card-body text-center">
            <h6>‚úÖ TensorFlow</h6>
            <div class="metric-badge bg-warning text-dark">v{loadMLTest.data.libraryTest.tensorflow.version}</div>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="card feature-card">
          <div class="card-body text-center">
            <h6>‚úÖ Scikit-learn v{loadMLTest.data.libraryTest.scikit_learn.version}</h6>
            <div class="text-success">Machine Learning Library - Successfully tested and operational</div>
            <div class="mt-2">
              <span class="badge bg-info text-white">Linear Regression</span>
              <span class="badge bg-info text-white ms-1">Data Preprocessing</span>
              <span class="badge bg-info text-white ms-1">Model Evaluation</span>
              <span class="badge bg-info text-white ms-1">Train/Test Split</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-12">
        <div class="alert alert-info">
          <h5>üõ†Ô∏è Framework Components Used:</h5>
          <ul class="mb-0">
            <li><strong>Model Storage:</strong> Persistent model saving with metadata</li>
            <li><strong>ML Predictor:</strong> Training and prediction interface</li>
            <li><strong>Data Management:</strong> JSON-based data exchange</li>
            <li><strong>Model Registry:</strong> Model catalog and versioning</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Display -->
  {PureMix.data.results.loadMLTest?.data?.actionResult ?
    <div class="row mb-4">
      <div class="col-12">
        <h2>üî¨ ML Training Results</h2>
        <div class="card">
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h5>Training Status</h5>
                <p><strong>Success:</strong> {PureMix.data.results.loadMLTest.data.actionResult.success ? '‚úÖ Success' : '‚ùå Error'}</p>
                <p><strong>Model Type:</strong> {PureMix.data.results.loadMLTest.data.actionResult.model_type}</p>
                <p><strong>Timestamp:</strong> {PureMix.data.results.loadMLTest.data.actionResult.timestamp}</p>
              </div>
              <div class="col-md-6">
                <h5>Results</h5>
                {PureMix.data.results.loadMLTest.data.actionResult.success ?
                  <div class="alert alert-success">
                    <strong>üéâ Model trained and saved successfully!</strong>
                    <p>Model ID: {PureMix.data.results.loadMLTest.data.actionResult.model_id}</p>
                    <p>You can now use this model for predictions in the Predict tab.</p>
                  </div> :
                  <div class="alert alert-danger">
                    <strong>‚ö†Ô∏è Training Error</strong>
                    <p>{PureMix.data.results.loadMLTest.data.actionResult.error}</p>
                  </div>
                }
              </div>
            </div>
            <details class="mt-3">
              <summary>Raw Response Data</summary>
              <pre class="bg-light p-3 rounded mt-2">{JSON.stringify(PureMix.data.results.loadMLTest.data.actionResult, null, 2)}</pre>
            </details>
          </div>
        </div>
      </div>
    </div>
  : <div></div>}
</div>

<script>
  // Populate training data with valid JSON
  function populateTrainingData() {
    const trainingDataTextarea = document.getElementById('trainingDataTextarea');
    if (trainingDataTextarea) {
      const sampleData = [
        {"features": [1.0, 2.0], "target": 3.5},
        {"features": [2.0, 3.0], "target": 5.8},
        {"features": [3.0, 1.0], "target": 4.2},
        {"features": [1.5, 2.5], "target": 4.1},
        {"features": [2.5, 1.5], "target": 4.8},
        {"features": [0.5, 3.5], "target": 4.3},
        {"features": [3.5, 0.5], "target": 3.9}
      ];
      // Use compact JSON (no pretty-printing) to avoid parsing issues
      trainingDataTextarea.value = JSON.stringify(sampleData);
    }
  }

  // Tab switching functionality
  function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
      tab.classList.remove('active');
    });

    // Remove active class from all nav links
    document.querySelectorAll('.nav-link').forEach(link => {
      link.classList.remove('active');
      link.setAttribute('aria-selected', 'false');
    });

    // Show selected tab
    document.getElementById(tabName).classList.add('active');

    // Mark selected nav link as active
    const activeLink = document.querySelector(`[aria-controls="${tabName}"]`);
    if (activeLink) {
      activeLink.classList.add('active');
      activeLink.setAttribute('aria-selected', 'true');
    }
  }

  // Tab click handlers
  document.getElementById('models-tab').addEventListener('click', () => showTab('models'));
  document.getElementById('train-tab').addEventListener('click', () => showTab('train'));
  document.getElementById('predict-tab').addEventListener('click', () => showTab('predict'));
  document.getElementById('library-tab').addEventListener('click', () => showTab('library'));

  // Load models on page load
  document.addEventListener('DOMContentLoaded', function() {
    populateTrainingData();
    loadModels();
    loadModelSelect();
  });
</script>

<script server>
  async function trainModel(formData, request) {
    try {
      // Handle both string and object trainingData
      let trainingData;
      if (typeof formData.trainingData === 'string') {
        // Handle HTML-escaped JSON from form submissions
        let decodedTrainingData = formData.trainingData
          .replace(/&quot;/g, '"')
          .replace(/&amp;/g, '&')
          .replace(/&lt;/g, '<')
          .replace(/&gt;/g, '>')
          .replace(/&#x27;/g, "'")
          .replace(/&#x2F;/g, "/");
        trainingData = JSON.parse(decodedTrainingData);
      } else {
        trainingData = formData.trainingData;
      }
      const modelName = formData.modelName;
      const modelDescription = formData.modelDescription;
      const algorithm = formData.algorithm;
      const testSize = parseFloat(formData.testSize);

      console.log('üöÄ Starting model training...');
      console.log('Model Name:', modelName);
      console.log('Data points:', trainingData.length);
      console.log('Algorithm:', algorithm);

      // Generate feature names dynamically
      const featureCount = trainingData[0].features.length;
      const features = Array.from({length: featureCount}, (_, i) => `feature_${i}`);

      // Use the persistent ML predictor with executeFile
      const result = await request.python.executeFile(
        './app/services/ml_predictor.py',
        'train_and_save_regression_model',
        trainingData,
        {
          'model_name': modelName,
          'model_type': 'Regression',
          'description': modelDescription,
          'algorithm': algorithm,
          'test_size': testSize,
          'hyperparameters': {},
          'features': features,
          'target_variable': 'target'
        }
      );

      console.log('‚úÖ Training completed:', result);

      return result;

    } catch (error) {
      console.error('‚ùå Training error:', error);
      return {
        success: false,
        error: error.message
      };
    }
  }

  async function makePrediction(formData, request) {
    try {
      const modelId = document.getElementById('modelSelect').value;
      const predictionData = JSON.parse(formData.predictionData);

      if (!modelId) {
        return {
          success: false,
          error: 'Please select a model first'
        };
      }

      console.log('üîÆ Making predictions with model:', modelId);
      console.log('Prediction data:', predictionData);

      const result = await request.python.call('predict_with_saved_model', {
        model_id: modelId,
        new_data: predictionData
      }, `
from services.ml_predictor import ml_predictor

def predict_with_saved_model(data, js_context=None):
    """Make predictions using a saved model"""
    try:
        return ml_predictor.predict_with_saved_model(
            data['model_id'],
            data['new_data']
        )
    except Exception as e:
        return {
            'success': False,
            'error': 'Prediction failed: ' + str(e)
        }
      `);

      console.log('‚úÖ Prediction completed:', result);

      return result;

    } catch (error) {
      console.error('‚ùå Prediction error:', error);
      return {
        success: false,
        error: error.message
      };
    }
  }

  async function refreshModels(formData, request) {
    console.log('üîÑ Refreshing models list...');
    // This will trigger a reload with updated models
    return {
      success: true,
      message: 'Models refreshed'
    };
  }

  async function deleteModel(formData, request) {
    try {
      const modelId = formData.modelId;

      console.log('üóëÔ∏è Deleting model:', modelId);

      const result = await request.python.call('delete_saved_model', {
        model_id: modelId
      }, `
from services.ml_predictor import ml_predictor

def delete_saved_model(data, js_context=None):
    """Delete a saved model"""
    try:
        return ml_predictor.delete_saved_model(data['model_id'])
    except Exception as e:
        return {
            'success': False,
            'error': 'Deletion failed: ' + str(e)
        }
      `);

      console.log('‚úÖ Model deletion completed:', result);

      return result;

    } catch (error) {
      console.error('‚ùå Delete error:', error);
      return {
        success: false,
        error: error.message
      };
    }
  }

  async function testWithSampleData(formData, request) {
    try {
      // Get the selected model ID from the form or client-side
      const modelId = formData.modelId;

      if (!modelId) {
        return {
          success: false,
          error: 'Please select a model first'
        };
      }

      console.log('üß™ Testing model with sample data:', modelId);

      // Call our new test-prediction API endpoint
      const response = await fetch('/api/test-prediction', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model_id: modelId
        })
      });

      const result = await response.json();

      console.log('‚úÖ Sample test completed:', result);

      // Add client-side action type for result handling
      result.action_type = 'test_sample_data';
      result.model_id = modelId;

      return result;

    } catch (error) {
      console.error('‚ùå Sample test error:', error);
      return {
        success: false,
        error: error.message,
        action_type: 'test_sample_data'
      };
    }
  }
</script>

<script client>
  // Client-side helper functions
  function loadModels() {
    const savedModels = window.PureMix?.data?.results?.loadMLTest?.data?.savedModels || { models: [] };
    const modelsContainer = document.getElementById('models-container');

    if (savedModels.models && savedModels.models.length > 0) {
      let html = '<div class="row">';

      savedModels.models.forEach(model => {
        const createdDate = new Date(model.created_at).toLocaleDateString();
        const performance = model.performance || {};

        html += `
          <div class="col-md-6 mb-3">
            <div class="card model-card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div>
                    <h5 class="mb-1">${model.model_name}</h5>
                    <p class="text-muted mb-1">${model.description || 'No description'}</p>
                  </div>
                  <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                      ‚öôÔ∏è
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="#" onclick="loadModelDetails('${model.model_id}')">üìä View Details</a></li>
                      <li><a class="dropdown-item text-danger" href="#" onclick="confirmDeleteModel('${model.model_id}', '${model.model_name}')">üóëÔ∏è Delete Model</a></li>
                    </ul>
                  </div>
                </div>

                <div class="row model-stats">
                  <div class="col-6">
                    <small class="text-muted">Type:</small>
                    <div class="fw-bold">${model.model_type}</div>
                  </div>
                  <div class="col-6">
                    <small class="text-muted">Created:</small>
                    <div class="fw-bold">${createdDate}</div>
                  </div>
                </div>

                ${performance.test_r2 ? `
                  <div class="mt-2">
                    <div class="progress mb-1">
                      <div class="progress-bar" style="width: ${Math.min(performance.test_r2 * 100, 100)}%">
                        <span class="sr-only">${(performance.test_r2 * 100).toFixed(1)}%</span>
                      </div>
                    </div>
                    <small class="text-muted">Test R¬≤: ${performance.test_r2.toFixed(4)}</small>
                  </div>
                ` : ''}

                <div class="mt-3">
                  <div class="d-grid gap-1">
                    <button class="btn btn-sm btn-success" onclick="loadModelForPrediction('${model.model_id}')">
                      üìà Use for Prediction
                    </button>
                    <button class="btn btn-sm btn-info" onclick="loadModelDetails('${model.model_id}')">
                      üìä View Details
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      });

      html += '</div>';
      modelsContainer.innerHTML = html;
    } else {
      modelsContainer.innerHTML = `
        <div class="text-center py-5">
          <div class="text-muted">
            <h4>üìÇ No saved models yet</h4>
            <p>Train your first model using the "Train New Model" tab.</p>
          </div>
        </div>
      `;
    }
  }

  function loadModelSelect() {
    const savedModels = window.PureMix?.data?.results?.loadMLTest?.data?.savedModels || { models: [] };
    const modelSelect = document.getElementById('modelSelect');
    const modelInfo = document.getElementById('selected-model-info');

    // Clear current options
    modelSelect.innerHTML = '<option value="">Choose a model...</option>';

    if (savedModels.models && savedModels.models.length > 0) {
      savedModels.models.forEach(model => {
        const option = document.createElement('option');
        option.value = model.model_id;
        option.textContent = `${model.model_name} (${model.model_type})`;
        modelSelect.appendChild(option);
      });

      // Enable predict button and test sample button
      const predictBtn = document.getElementById('predictBtn');
      const testSampleBtn = document.getElementById('testSampleBtn');
      if (predictBtn) {
        predictBtn.disabled = false;
      }
      if (testSampleBtn) {
        testSampleBtn.disabled = false;
      }
    } else {
      // Disable buttons when no models available
      const predictBtn = document.getElementById('predictBtn');
      const testSampleBtn = document.getElementById('testSampleBtn');
      if (predictBtn) {
        predictBtn.disabled = true;
      }
      if (testSampleBtn) {
        testSampleBtn.disabled = true;
      }
    }

    modelInfo.innerHTML = '<small class="text-muted">Select a model to view details</small>';
  }

  function loadModelForPrediction(modelId) {
    // Switch to predict tab
    showTab('predict');

    // Select the model in dropdown
    const modelSelect = document.getElementById('modelSelect');
    modelSelect.value = modelId;

    // Load model details
    loadModelDetails(modelId);

    // Focus on prediction data field
    const predictionData = document.querySelector('textarea[name="predictionData"]');
    if (predictionData) {
      predictionData.focus();
    }
  }

  function loadModelDetails(modelId) {
    const savedModels = window.PureMix?.data?.results?.loadMLTest?.data?.savedModels || { models: [] };
    const model = savedModels.models.find(m => m.model_id === modelId);
    const modelInfo = document.getElementById('selected-model-info');

    if (model && modelInfo) {
      const createdDate = new Date(model.created_at).toLocaleString();
      const performance = model.performance || {};

      modelInfo.innerHTML = `
        <div class="small">
          <strong>Created:</strong> ${createdDate}<br>
          <strong>Type:</strong> ${model.model_type}<br>
          ${performance.test_r2 ? `<strong>Test R¬≤:</strong> ${performance.test_r2.toFixed(4)}` : ''}
        </div>
      `;
    }
  }

  function confirmDeleteModel(modelId, modelName) {
    if (confirm(`Are you sure you want to delete "${modelName}"? This action cannot be undone.`)) {
      const form = document.createElement('form');
      form.method = 'POST';
      form.innerHTML = `<input type="hidden" name="modelId" value="${modelId}">`;

      document.body.appendChild(form);
      form.submit();
    }
  }

  function testWithSampleData() {
    const modelSelect = document.getElementById('modelSelect');
    const modelId = modelSelect.value;

    if (!modelId) {
      alert('Please select a model first');
      return;
    }

    // Show loading state
    const testSampleBtn = document.getElementById('testSampleBtn');
    const originalText = testSampleBtn.innerHTML;
    testSampleBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Testing...';
    testSampleBtn.disabled = true;

    // Create and submit form for test prediction
    const form = document.createElement('form');
    form.method = 'POST';
    form.innerHTML = `<input type="hidden" name="modelId" value="${modelId}">`;
    form.innerHTML += `<input type="hidden" name="testSampleData" value="true">`;

    document.body.appendChild(form);
    form.submit();
  }

  // Display sample data test results
  function displaySampleTestResults(result) {
    const sampleTestResultsRow = document.getElementById('sample-test-results-row');
    const sampleTestResults = document.getElementById('sample-test-results');

    if (sampleTestResultsRow && sampleTestResults) {
      if (result.success) {
        let html = '<div class="row">';

        // Test Summary
        html += `
          <div class="col-md-4">
            <div class="card h-100">
              <div class="card-body">
                <h6 class="card-title">üìã Test Summary</h6>
                <div class="small">
                  <strong>Model:</strong> ${result.model_info.name}<br>
                  <strong>Type:</strong> ${result.model_info.type}<br>
                  <strong>Test Samples:</strong> ${result.test_summary.num_samples}<br>
                  <strong>Features:</strong> ${result.test_summary.feature_count}<br>
                  <strong>Test Date:</strong> ${new Date(result.timestamp).toLocaleString()}
                </div>
              </div>
            </div>
          </div>
        `;

        // Sample Data Used
        html += `
          <div class="col-md-4">
            <div class="card h-100">
              <div class="card-body">
                <h6 class="card-title">üß™ Sample Data Used</h6>
                <div class="json-preview small">
                  <strong>Description:</strong> ${result.sample_data_description}<br><br>
                  <strong>Test Data:</strong><br>
                  ${JSON.stringify(result.test_data, null, 2)}
                </div>
              </div>
            </div>
          </div>
        `;

        // Predictions
        html += `
          <div class="col-md-4">
            <div class="card h-100">
              <div class="card-body">
                <h6 class="card-title">üéØ Prediction Results</h6>
                <div class="prediction-result small">
                  ${result.predictions.map((pred, i) => `
                    <div class="mb-2">
                      <strong>Sample ${i + 1}:</strong> ${typeof pred === 'number' ? pred.toFixed(4) : pred}
                    </div>
                  `).join('')}
                </div>
                ${result.model_info.performance ? `
                  <div class="mt-3 small">
                    <strong>Model Performance:</strong><br>
                    R¬≤ Score: ${(result.model_info.performance.r2_score || result.model_info.performance.test_r2 || 'N/A')}
                  </div>
                ` : ''}
              </div>
            </div>
          </div>
        `;

        html += '</div>';

        // Add test again button
        html += `
          <div class="row mt-3">
            <div class="col-12 text-center">
              <button class="btn btn-info" onclick="testWithSampleData()">
                üîÑ Test Again with Different Samples
              </button>
              <button class="btn btn-success ms-2" onclick="loadModelForPrediction('${result.model_id}')">
                üìà Make Custom Predictions
              </button>
            </div>
          </div>
        `;

        sampleTestResults.innerHTML = html;
        sampleTestResultsRow.style.display = 'block';

      } else {
        sampleTestResults.innerHTML = `
          <div class="alert alert-danger">
            <strong>‚ùå Sample Test Failed</strong>
            <p>${result.error}</p>
            ${result.suggestion ? `<p><strong>Suggestion:</strong> ${result.suggestion}</p>` : ''}
          </div>
        `;
        sampleTestResultsRow.style.display = 'block';
      }

      // Reset test button
      const testSampleBtn = document.getElementById('testSampleBtn');
      if (testSampleBtn) {
        testSampleBtn.innerHTML = 'üß™ Test with Sample Data';
        testSampleBtn.disabled = false;
      }
    }
  }

  // Update models count in tab
  function updateModelsCount() {
    const savedModels = window.PureMix?.data?.results?.loadMLTest?.data?.savedModels || { models: [] };
    const modelsTab = document.getElementById('models-tab');
    if (modelsTab) {
      modelsTab.textContent = `üóÉÔ∏è Saved Models (${savedModels.count || 0})`;
    }
  }

  // Enhanced prediction results display
  function displayPredictionResults(result) {
    const predictionResults = document.getElementById('prediction-results');

    if (predictionResults) {
      if (result.success) {
        const predictions = result.predictions || [];
        const intervals = result.prediction_intervals || [];
        const metadata = result.model_metadata || {};

        let html = '<div class="prediction-result">';

        html += '<h6>üéØ Predictions</h6>';
        predictions.forEach((pred, i) => {
          const interval = intervals[i] || [0, 0];
          html += `
            <div class="mb-2">
              <strong>Prediction ${i + 1}:</strong> ${pred.toFixed(4)}
              <small class="ms-2">(${interval[0].toFixed(2)} - ${interval[1].toFixed(2)})</small>
            </div>
          `;
        });

        html += '<h6 class="mt-3">üìä Model Information</h6>';
        html += `<div class="model-stats">`;
        html += `<strong>Model Type:</strong> ${metadata.model_type}<br>`;
        html += `<strong>Created:</strong> ${metadata.created_at ? new Date(metadata.created_at).toLocaleString() : 'Unknown'}<br>`;
        html += `<strong>Features:</strong> ${metadata.features?.join(', ') || 'Unknown'}`;
        if (metadata.performance) {
          html += `<br><strong>Test R¬≤:</strong> ${metadata.performance.test_r2?.toFixed(4) || 'N/A'}`;
        }
        html += '</div>';

        html += '</div>';
        predictionResults.innerHTML = html;
      } else {
        predictionResults.innerHTML = `
          <div class="alert alert-danger">
            <strong>‚ùå Prediction Failed</strong>
            <p>${result.error}</p>
          </div>
        `;
      }
    }
  }

  // Enhanced training results display
  function displayTrainingResults(result) {
    const trainingResults = document.getElementById('training-results');

    if (trainingResults) {
      if (result.success) {
        const performance = result.performance || {};

        let html = '<div class="alert alert-success">';
        html += `<h6>üéâ Model Trained Successfully!</h6>`;
        html += `<p><strong>Model ID:</strong> <code>${result.model_id?.substring(0, 8)}...</code></p>`;
        html += `<p><strong>Model Type:</strong> ${result.model_type}</p>`;

        if (performance.test_r2 !== undefined) {
          const r2Score = performance.test_r2;
          html += `<div class="progress mb-2">`;
          html += `<div class="progress-bar" style="width: ${Math.min(r2Score * 100, 100)}%">`;
          html += `<span class="sr-only">${(r2Score * 100).toFixed(1)}%</span>`;
          html += `</div>`;
          html += `<small>R¬≤ Score: ${r2Score.toFixed(4)}</small>`;
          html += `</div>`;
        }

        html += '<div class="row mt-3">';
        html += `<div class="col-6"><strong>Training Samples:</strong> ${result.training_data_used}</div>`;
        html += `<div class="col-6"><strong>Data Shape:</strong> ${result.data_shape}</div>`;
        html += '</div>';

        // Add test model invitation
        html += `
          <div class="alert alert-info mt-3">
            <h6>üéâ Model Ready for Testing!</h6>
            <p>Your model has been trained and saved successfully. Test it now with intelligent sample data to see how it performs.</p>
            <div class="d-grid gap-2 d-md-flex">
              <button class="btn btn-info" onclick="loadModelForPrediction('${result.model_id}')">
                üß™ Test with Sample Data
              </button>
              <button class="btn btn-success" onclick="loadModelForPrediction('${result.model_id}')">
                üìà Make Custom Predictions
              </button>
            </div>
          </div>
        `;

        html += '</div>';
        trainingResults.innerHTML = html;

        // Refresh models list
        setTimeout(() => {
          loadModels();
          loadModelSelect();
          updateModelsCount();
        }, 1000);
      } else {
        trainingResults.innerHTML = `
          <div class="alert alert-danger">
            <strong>‚ùå Training Failed</strong>
            <p>${result.error}</p>
          </div>
        `;
      }
    }
  }

  // Monitor PureMix data updates for results
  setInterval(() => {
    const actionResult = window.PureMix?.data?.results?.loadMLTest?.data?.actionResult;
    if (actionResult) {
      displayTrainingResults(actionResult);
    }
  }, 500);

  setInterval(() => {
    const predictionResult = window.PureMix?.data?.results?.loadMLTest?.data?.actionResult;
    if (predictionResult && predictionResult.model_id) {
      displayPredictionResults(predictionResult);
    }
  }, 500);

  // Monitor for sample test results
  setInterval(() => {
    const actionResult = window.PureMix?.data?.results?.loadMLTest?.data?.actionResult;
    if (actionResult && actionResult.action_type === 'test_sample_data') {
      displaySampleTestResults(actionResult);
    }
  }, 500);

  // Initialize
  loadModels();
  loadModelSelect();
  updateModelsCount();
</script>
</body>
</html>